# TV-ML: Scripts and workflow for the Tilted V catchment machine learning emulator

This repo contains a setup to train 2D and 3D ML emulator models for the results of the 2D Tilted-V domain run with ParFlow.  The approach, models, and results are detailed in [Maxwell, Condon, Melchior (2021)](https://www.mdpi.com/2073-4441/13/24/3633) 

## Repo Contents
This repo contains *example* 2D and 3D workflows to train and evaluate ML emulator models, along with a sample shell script to run them, helper modules to manipulate the ParFlow data, and a library of models.  This repo takes training and evaluation information from a suite of ParFlow simulations that need to be generated prior to running the scripts in this repo.  They are documented in the [TiltedV-2d](https://github.com/HydroGEN-pubs/TiltedV-2D) GitHub repo. 

1. Training 2D and 3D (`train_*d_example.py`): This script conducts the training for the ML based on the ParFlow Tilted V runs.  note that this script creates a local model directory based on the second command line argument, which is the `config_name` variable in the `run_workflow.sh` shell script below.  This is where the trained model is saved, along with lots of provenance information, including a copy of the training python script itself.  This script loads the `workflow.yaml` file below and looks for the location of the ParFlow simulations using the `local_path` variable in that file.

2. Evaluating 2D and 3D (`eval_*d_example.py`): These scripts evaluates the trained ML on two test datasets generated by the TiltedV-2D. It takes the same command line arguments as the Training script and needs the evaluation ensembles from the same ParFlow TitledV-2D run suite.  It generates additional files, both in the model directory where the pytorch model is saved and a suite a results files as PDF and markdown that graph and detail the model performance. 

3. Shell script to orchestrate runs (`run_workflow.sh`).

4. YAML file database with user and model information (`workflow.yaml`).


**Reference**
<Br>
*Maxwell, R.M.; Condon, L.E.; Melchior, P. A Physics-Informed, Machine Learning Emulator of a 2D Surface Water Model: What Temporal Networks and Simulation-Based Inference Can Help Us Learn about Hydrologic Processes. Water 2021, 13, 3633. https://doi.org/10.3390/w13243633*